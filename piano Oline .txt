<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿé’¢ç´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            padding: 20px;
            overflow-x: auto;
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            text-align: center;
        }
        
        header {
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .description {
            font-size: 1.1rem;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        .piano-container {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-bottom: 30px;
            overflow-x: auto;
            position: relative;
        }
        
        .scroll-hint {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 0.8rem;
            opacity: 0.7;
            display: flex;
            align-items: center;
        }
        
        .scroll-hint svg {
            margin-left: 5px;
        }
        
        .piano {
            position: relative;
            height: 220px;
            display: flex;
            margin: 0 auto;
            min-width: 1200px;
        }
        
        .key {
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 10px;
            user-select: none;
            transition: transform 0.1s ease;
        }
        
        .key:active {
            transform: translateY(2px);
        }
        
        .white-key {
            width: 30px;
            height: 100%;
            background: linear-gradient(to bottom, #fff 0%, #f5f5f5 100%);
            border: 1px solid #ccc;
            border-radius: 0 0 5px 5px;
            color: #333;
            z-index: 1;
            margin-right: -1px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        
        .white-key.active {
            background: linear-gradient(to bottom, #e0e0e0 0%, #d0d0d0 100%);
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
        }
        
        .black-key {
            width: 20px;
            height: 60%;
            background: linear-gradient(to bottom, #333 0%, #000 100%);
            border-radius: 0 0 4px 4px;
            color: white;
            z-index: 2;
            margin-left: -10px;
            margin-right: -10px;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.5);
        }
        
        .black-key.active {
            background: linear-gradient(to bottom, #222 0%, #111 100%);
            box-shadow: inset 0 2px 3px rgba(0, 0, 0, 0.5);
        }
        
        .note-name {
            font-size: 0.6rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .key-label {
            font-size: 0.7rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            min-width: 16px;
        }
        
        .white-key .key-label {
            color: #333;
        }
        
        .black-key .key-label {
            color: white;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .active-control {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
        }
        
        .keyboard-hint {
            margin-top: 20px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            max-width: 900px;
        }
        
        .instructions h2 {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .instructions ul {
            list-style-position: inside;
            padding-left: 10px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .key-mapping {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .key-mapping-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        .octave-display {
            margin-top: 15px;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .visitor-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .visitor-info p {
            margin: 5px 0;
        }
        
        footer {
            margin-top: 30px;
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        /* æ¨ªå±æç¤ºæ ·å¼ */
        .landscape-notice {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .landscape-notice h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #fdbb2d;
        }
        
        .landscape-notice p {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }
        
        .landscape-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: rotate 2s infinite;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
            100% { transform: rotate(0deg); }
        }
        
        @media (max-width: 768px) {
            .piano {
                height: 180px;
            }
            
            .white-key {
                width: 20px;
            }
            
            .black-key {
                width: 14px;
                margin-left: -7px;
                margin-right: -7px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .note-name, .key-label {
                font-size: 0.5rem;
            }
        }
        
        @media (orientation: landscape) {
            .landscape-notice {
                display: none;
            }
        }

/* å¯¹è¯æ¡†æ ·å¼ */
.dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.dialog-overlay.active {
    opacity: 1;
    visibility: visible;
}

.dialog-box {
    background-color: white;
    border-radius: 10px;
    padding: 25px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    transform: translateY(20px);
    transition: transform 0.3s ease;
    text-align: center;
}

.dialog-overlay.active .dialog-box {
    transform: translateY(0);
}

.dialog-title {
    font-size: 22px;
    color: #333;
    margin-bottom: 15px;
}

.dialog-message {
    font-size: 16px;
    color: #666;
    margin-bottom: 20px;
}

.dialog-button {
    background-color: #4a6ee0;
    color: white;
    border: none;
    padding: 10px 25px;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.dialog-button:hover {
    background-color: #3a5ecf;
}

/* å¯ç‚¹å‡»æ–‡å­—æ ·å¼ */
.clickable-text {
    color: #4a6ee0;
    cursor: pointer;
    text-decoration: underline;
    transition: color 0.3s ease;
}

.clickable-text:hover {
    color: #3a5ecf;
}

/* å¯¹è¯æ¡†æ ·å¼ */
.dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.dialog-overlay.active {
    opacity: 1;
    visibility: visible;
}

.dialog-box {
    background-color: white;
    border-radius: 10px;
    padding: 25px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    transform: translateY(20px);
    transition: transform 0.3s ease;
    text-align: center;
}

.dialog-overlay.active .dialog-box {
    transform: translateY(0);
}

.dialog-title {
    font-size: 22px;
    color: #333;
    margin-bottom: 15px;
}

.dialog-message {
    font-size: 16px;
    color: #666;
    margin-bottom: 20px;
}

.dialog-button {
    background-color: #4a6ee0;
    color: white;
    border: none;
    padding: 10px 25px;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.dialog-button:hover {
    background-color: #3a5ecf;
}

/* å¯ç‚¹å‡»æ–‡å­—æ ·å¼ */
.clickable-text {
    color: #4a6ee0;
    cursor: pointer;
    text-decoration: underline;
    transition: color 0.3s ease;
}

.clickable-text:hover {
    color: #3a5ecf;
}
    </style>
</head>
<body>
    <!-- æ¨ªå±æç¤º -->
    <div class="landscape-notice" id="landscapeNotice">
        <div class="landscape-icon">ğŸ“±</div>
        <h2>æ¨ªå±ä½¿ç”¨æ•ˆæœæ›´ä½³</h2>
        <p>è¯·å°†è®¾å¤‡æ—‹è½¬è‡³æ¨ªå±æ¨¡å¼</p>
    </div>

    <div class="container">
        <header>
            <h1>è™šæ‹Ÿé’¢ç´</h1>
                   </header>
        
        <div class="piano-container">
            <div class="scroll-hint">
                æ»šåŠ¨ä»¥æŸ¥çœ‹æ‰€æœ‰ç´é”®
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M7 10l5 5 5-5"/>
                </svg>
            </div>
            <div class="piano" id="piano">
                <!-- ç´é”®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="controls">
                <button id="sustainBtn">å³è¸æ¿: å…³</button>
                <button id="recordBtn">å¼€å§‹å½•éŸ³</button>
                <button id="playBtn" disabled>æ’­æ”¾å½•éŸ³</button>
                <button id="clearBtn">æ¸…é™¤å½•éŸ³</button>
                <button id="octaveUpBtn">æé«˜å…«åº¦</button>
                <button id="octaveDownBtn">é™ä½å…«åº¦</button>
            </div>
            
            <div class="octave-display" id="octaveDisplay">å½“å‰å…«åº¦: 4 (ä¸­å¤®C)</div>
            
            <p class="keyboard-hint">æ¯ä¸ªç´é”®ä¸Šéƒ½æ ‡æ³¨äº†å¯¹åº”çš„é”®ç›˜æŒ‰é”®</p>
            
            <!-- è®¿é—®è€…ä¿¡æ¯ -->
            <div class="visitor-info" id="visitorInfo">
                <p>æ­£åœ¨è·å–æ‚¨çš„ä¿¡æ¯...</p>
            </div>
        </div>
        
        <div class="instructions">
            <h2>é”®ç›˜æ˜ å°„è¯´æ˜</h2>
            <ul>
                <li><strong>ç™½é”®</strong>: ä½¿ç”¨é”®ç›˜ä¸­é—´è¡ŒæŒ‰é”® (A S D F G H J K L ; ')</li>
                <li><strong>é»‘é”®</strong>: ä½¿ç”¨é”®ç›˜ä¸Šæ–¹çš„æ•°å­—é”® (1 2 4 5 6)</li>
                <li><strong>å…«åº¦åˆ‡æ¢</strong>: ä½¿ç”¨ [ å’Œ ] é”®åˆ‡æ¢å…«åº¦</li>
                <li><strong>å»¶éŸ³æ•ˆæœ</strong>: æŒ‰ç©ºæ ¼é”®å¼€å¯/å…³é—­å»¶éŸ³</li>
                <li><strong>å½•éŸ³åŠŸèƒ½</strong>: æŒ‰ R é”®å¼€å§‹/åœæ­¢å½•éŸ³ï¼ŒP é”®æ’­æ”¾å½•éŸ³</li>
            </ul>
            
            <div class="key-mapping">
                <div class="key-mapping-item"><span>ç™½é”® (ä¸‹å…«åº¦):</span> <span>Z X C V B N M , . /</span></div>
                <div class="key-mapping-item"><span>ç™½é”® (å½“å‰å…«åº¦):</span> <span>A S D F G H J K L ; '</span></div>
                <div class="key-mapping-item"><span>ç™½é”® (ä¸Šå…«åº¦):</span> <span>Q W E R T Y U I O P</span></div>
                <div class="key-mapping-item"><span>é»‘é”® (ä¸‹å…«åº¦):</span> <span>S D G H J</span></div>
                <div class="key-mapping-item"><span>é»‘é”® (å½“å‰å…«åº¦):</span> <span>1 2 4 5 6</span></div>
                <div class="key-mapping-item"><span>é»‘é”® (ä¸Šå…«åº¦):</span> <span>W E T Y U</span></div>
                <div class="key-mapping-item"><span>å…«åº¦ä¸Š:</span> <span>]</span></div>
                <div class="key-mapping-item"><span>å…«åº¦ä¸‹:</span> <span>[</span></div>
                <div class="key-mapping-item"><span>å³è¸æ¿:</span> <span>ç©ºæ ¼é”®</span></div>
                <div class="key-mapping-item"><span>å½•éŸ³:</span> <span>R</span></div>
                <div class="key-mapping-item"><span>æ’­æ”¾:</span> <span>P</span></div>
            </div>
        </div>
        
    <!-- å¯¹è¯æ¡†HTMLç»“æ„ -->
   </div>

<!-- å¯¹è¯æ¡†HTMLç»“æ„ -->
<div class="dialog-overlay" id="dialogOverlay">
    <div class="dialog-box">
        <h2 class="dialog-title">ä½ å¥½ï¼</h2>
        <p class="dialog-message">æ¬¢è¿è®¿é—®æˆ‘ä»¬çš„ç½‘ç«™ï¼</p>
        <button class="dialog-button" onclick="hideDialog()">ç¡®å®š</button>
    </div>
</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const piano = document.getElementById('piano');
            const sustainBtn = document.getElementById('sustainBtn');
            const recordBtn = document.getElementById('recordBtn');
            const playBtn = document.getElementById('playBtn');
            const clearBtn = document.getElementById('clearBtn');
            const octaveUpBtn = document.getElementById('octaveUpBtn');
            const octaveDownBtn = document.getElementById('octaveDownBtn');
            const octaveDisplay = document.getElementById('octaveDisplay');
            const landscapeNotice = document.getElementById('landscapeNotice');
            const visitorInfo = document.getElementById('visitorInfo');
            
            let audioContext;
            let sustain = false;
            let isRecording = false;
            let recordedNotes = [];
            let startTime;
            let currentOctave = 4; // ä¸­å¤®Cæ‰€åœ¨çš„å…«åº¦
            
            // 1. æ˜¾ç¤ºæ¨ªå±æç¤º1.5ç§’
            setTimeout(() => {
                landscapeNotice.style.display = 'none';
            }, 1500);
            
            // 2. è·å–è®¿é—®è€…IPå’Œä½ç½®ä¿¡æ¯
            async function getVisitorInfo() {
                try {
                    // ä½¿ç”¨ipapi.coè·å–IPå’Œä½ç½®ä¿¡æ¯
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    
                    visitorInfo.innerHTML = `
                        <p><strong>æ‚¨çš„IPåœ°å€:</strong> ${data.ip}</p>
                        <p><strong>æ‚¨çš„ä½ç½®:</strong> ${data.city}, ${data.region}, ${data.country_name}</p>
                        <p><strong>ç½‘ç»œæä¾›å•†:</strong> ${data.org}</p>
                    `;
                } catch (error) {
                    console.error('è·å–IPä¿¡æ¯å¤±è´¥:', error);
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ipifyè·å–IPåœ°å€
                    try {
                        const ipResponse = await fetch('https://api.ipify.org?format=json');
                        const ipData = await ipResponse.json();
                        visitorInfo.innerHTML = `
                            <p><strong>æ‚¨çš„IPåœ°å€:</strong> ${ipData.ip}</p>
                            <p>æ— æ³•è·å–è¯¦ç»†ä½ç½®ä¿¡æ¯</p>
                        `;
                    } catch (fallbackError) {
                        console.error('å¤‡ç”¨IPè·å–ä¹Ÿå¤±è´¥:', fallbackError);
                        visitorInfo.innerHTML = `<p>æ— æ³•è·å–IPå’Œä½ç½®ä¿¡æ¯</p>`;
                    }
                }
            }
            
            // é’¢ç´é”®é…ç½® - å®Œæ•´88é”®é’¢ç´ä»A0åˆ°C8
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            // å®Œæ•´çš„é”®ç›˜æ˜ å°„ - è¦†ç›–ä¸‰ä¸ªå…«åº¦èŒƒå›´
            const keyboardMap = {
                // ä¸‹å…«åº¦ç™½é”® (Z-/)
                'z': {noteIndex: 0, octaveOffset: -1}, 'x': {noteIndex: 2, octaveOffset: -1},
                'c': {noteIndex: 4, octaveOffset: -1}, 'v': {noteIndex: 5, octaveOffset: -1},
                'b': {noteIndex: 7, octaveOffset: -1}, 'n': {noteIndex: 9, octaveOffset: -1},
                'm': {noteIndex: 11, octaveOffset: -1}, ',': {noteIndex: 0, octaveOffset: 0},
                '.': {noteIndex: 2, octaveOffset: 0}, '/': {noteIndex: 4, octaveOffset: 0},
                
                // å½“å‰å…«åº¦ç™½é”® (A-')
                'a': {noteIndex: 0, octaveOffset: 0}, 's': {noteIndex: 2, octaveOffset: 0},
                'd': {noteIndex: 4, octaveOffset: 0}, 'f': {noteIndex: 5, octaveOffset: 0},
                'g': {noteIndex: 7, octaveOffset: 0}, 'h': {noteIndex: 9, octaveOffset: 0},
                'j': {noteIndex: 11, octaveOffset: 0}, 'k': {noteIndex: 0, octaveOffset: 1},
                'l': {noteIndex: 2, octaveOffset: 1}, ';': {noteIndex: 4, octaveOffset: 1},
                "'": {noteIndex: 5, octaveOffset: 1},
                
                // ä¸Šå…«åº¦ç™½é”® (Q-P)
                'q': {noteIndex: 7, octaveOffset: 1}, 'w': {noteIndex: 9, octaveOffset: 1},
                'e': {noteIndex: 11, octaveOffset: 1}, 'r': {noteIndex: 0, octaveOffset: 2},
                't': {noteIndex: 2, octaveOffset: 2}, 'y': {noteIndex: 4, octaveOffset: 2},
                'u': {noteIndex: 5, octaveOffset: 2}, 'i': {noteIndex: 7, octaveOffset: 2},
                'o': {noteIndex: 9, octaveOffset: 2}, 'p': {noteIndex: 11, octaveOffset: 2},
                
                // ä¸‹å…«åº¦é»‘é”® (S, D, G, H, J)
                's': {noteIndex: 1, octaveOffset: -1}, 'd': {noteIndex: 3, octaveOffset: -1},
                'g': {noteIndex: 6, octaveOffset: -1}, 'h': {noteIndex: 8, octaveOffset: -1},
                'j': {noteIndex: 10, octaveOffset: -1},
                
                // å½“å‰å…«åº¦é»‘é”® (1, 2, 4, 5, 6)
                '1': {noteIndex: 1, octaveOffset: 0}, '2': {noteIndex: 3, octaveOffset: 0},
                '4': {noteIndex: 6, octaveOffset: 0}, '5': {noteIndex: 8, octaveOffset: 0},
                '6': {noteIndex: 10, octaveOffset: 0},
                
                // ä¸Šå…«åº¦é»‘é”® (W, E, T, Y, U)
                'w': {noteIndex: 1, octaveOffset: 1}, 'e': {noteIndex: 3, octaveOffset: 1},
                't': {noteIndex: 6, octaveOffset: 1}, 'y': {noteIndex: 8, octaveOffset: 1},
                'u': {noteIndex: 10, octaveOffset: 1}
            };
            
            // é”®ç›˜æŒ‰é”®åˆ°æ˜¾ç¤ºæ ‡ç­¾çš„æ˜ å°„
            const keyLabels = {
                // ç™½é”®
                'z': 'Z', 'x': 'X', 'c': 'C', 'v': 'V', 'b': 'B', 'n': 'N', 'm': 'M', ',': ',', '.': '.', '/': '/',
                'a': 'A', 's': 'S', 'd': 'D', 'f': 'F', 'g': 'G', 'h': 'H', 'j': 'J', 'k': 'K', 'l': 'L', ';': ';', "'": "'",
                'q': 'Q', 'w': 'W', 'e': 'E', 'r': 'R', 't': 'T', 'y': 'Y', 'u': 'U', 'i': 'I', 'o': 'O', 'p': 'P',
                // é»‘é”®
                '1': '1', '2': '2', '4': '4', '5': '5', '6': '6'
            };
            
            // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
            function initAudio() {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            // ç”Ÿæˆé’¢ç´é”®
            function createPianoKeys() {
                piano.innerHTML = '';
                
                // åˆ›å»ºå®Œæ•´çš„88é”®é’¢ç´ (A0åˆ°C8)
                for (let octave = 0; octave <= 8; octave++) {
                    for (let noteIndex = 0; noteIndex < 12; noteIndex++) {
                        // è·³è¿‡ä¸å­˜åœ¨çš„é”®
                        if (octave === 0 && noteIndex < 9) continue; // A0ä¹‹å‰æ²¡æœ‰é”®
                        if (octave === 8 && noteIndex > 0) continue; // C8ä¹‹åæ²¡æœ‰é”®
                        
                        const noteName = noteNames[noteIndex];
                        const isBlackKey = noteName.includes('#');
                        const keyElement = document.createElement('div');
                        
                        keyElement.className = `key ${isBlackKey ? 'black-key' : 'white-key'}`;
                        keyElement.dataset.note = `${noteName}${octave}`;
                        keyElement.dataset.frequency = getFrequency(noteIndex, octave);
                        
                        // æ·»åŠ éŸ³ç¬¦åç§°
                        const noteNameElement = document.createElement('div');
                        noteNameElement.className = 'note-name';
                        // åªæ˜¾ç¤ºéƒ¨åˆ†æ ‡ç­¾ä»¥é¿å…æ··ä¹±
                        if ((octave === 4 && noteIndex === 0) || // C4
                            (octave === 0 && noteIndex === 9) || // A0
                            (octave === 8 && noteIndex === 0)) { // C8
                            noteNameElement.textContent = `${noteName}${octave}`;
                        }
                        keyElement.appendChild(noteNameElement);
                        
                        // æ·»åŠ é”®ç›˜æ ‡ç­¾
                        const keyLabel = findKeyLabel(noteName, octave);
                        if (keyLabel) {
                            const keyLabelElement = document.createElement('div');
                            keyLabelElement.className = 'key-label';
                            keyLabelElement.textContent = keyLabel;
                            keyElement.appendChild(keyLabelElement);
                        }
                        
                        keyElement.addEventListener('mousedown', () => playNote(noteName, octave, keyElement));
                        keyElement.addEventListener('mouseup', () => stopNote(keyElement));
                        keyElement.addEventListener('mouseleave', () => stopNote(keyElement));
                        
                        // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
                        keyElement.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            playNote(noteName, octave, keyElement);
                        });
                        keyElement.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            stopNote(keyElement);
                        });
                        
                        piano.appendChild(keyElement);
                    }
                }
            }
            
            // æ ¹æ®éŸ³ç¬¦å’Œå…«åº¦æ‰¾åˆ°å¯¹åº”çš„é”®ç›˜æ ‡ç­¾
            function findKeyLabel(noteName, octave) {
                const noteIndex = noteNames.indexOf(noteName);
                
                for (const [key, mapping] of Object.entries(keyboardMap)) {
                    const actualOctave = currentOctave + mapping.octaveOffset;
                    if (actualOctave === octave && mapping.noteIndex === noteIndex) {
                        return keyLabels[key] || key.toUpperCase();
                    }
                }
                
                return null;
            }
            
            // æ’­æ”¾éŸ³ç¬¦ - ä½¿ç”¨æ›´æŸ”å’Œçš„éŸ³è‰²
            function playNote(note, octave, keyElement) {
                if (!audioContext) {
                    initAudio();
                }
                
                // æ·»åŠ æ¿€æ´»çŠ¶æ€
                keyElement.classList.add('active');
                
                // è®°å½•éŸ³ç¬¦ï¼ˆå¦‚æœæ­£åœ¨å½•éŸ³ï¼‰
                if (isRecording) {
                    const currentTime = Date.now() - startTime;
                    recordedNotes.push({
                        note: note,
                        octave: octave,
                        time: currentTime,
                        duration: 500 // é»˜è®¤æŒç»­æ—¶é—´
                    });
                }
                
                // åˆ›å»ºæŒ¯è¡å™¨
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                // è®¾ç½®é¢‘ç‡
                const frequency = getFrequency(noteNames.indexOf(note), octave);
                oscillator.frequency.value = frequency;
                
                // ä½¿ç”¨æ›´æŸ”å’Œçš„æ³¢å½¢ - ä¸‰è§’æ³¢å’Œæ­£å¼¦æ³¢æ··åˆ
                oscillator.type = 'triangle';
                
                // æ·»åŠ ä½é€šæ»¤æ³¢å™¨ä½¿éŸ³è‰²æ›´æŸ”å’Œ
                filter.type = 'lowpass';
                filter.frequency.value = 2000; // é™ä½é«˜é¢‘æˆåˆ†
                filter.Q.value = 0.5; // é€‚ä¸­çš„å…±æŒ¯å€¼
                
                // è¿æ¥èŠ‚ç‚¹: æŒ¯è¡å™¨ -> æ»¤æ³¢å™¨ -> å¢ç›Š -> è¾“å‡º
                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // è®¾ç½®æ›´è‡ªç„¶çš„éŸ³é‡åŒ…ç»œ
                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                
                // å¿«é€Ÿèµ·éŸ³
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.02);
                
                // è¾ƒçŸ­çš„è¡°å‡
                gainNode.gain.exponentialRampToValueAtTime(0.15, now + 0.1);
                
                // å»¶éŸ³å¤„ç†
                if (sustain) {
                    // å»¶éŸ³å¼€å¯æ—¶ï¼ŒéŸ³ç¬¦æŒç»­æ›´é•¿æ—¶é—´ä½†ä¼šè‡ªç„¶è¡°å‡
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 1.5); // 1.5ç§’è¡°å‡
                } else {
                    // æ— å»¶éŸ³æ—¶ï¼ŒéŸ³ç¬¦å¿«é€Ÿè¡°å‡
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.8); // 0.8ç§’è¡°å‡
                }
                
                // å¼€å§‹æ’­æ”¾
                oscillator.start();
                
                // å­˜å‚¨æŒ¯è¡å™¨å¼•ç”¨ä»¥ä¾¿åœæ­¢
                keyElement.dataset.oscillator = JSON.stringify({
                    oscillator: oscillator,
                    gainNode: gainNode
                });
            }
            
            // åœæ­¢éŸ³ç¬¦
            function stopNote(keyElement) {
                keyElement.classList.remove('active');
                
                const oscillatorData = keyElement.dataset.oscillator;
                if (oscillatorData) {
                    const { oscillator, gainNode } = JSON.parse(oscillatorData);
                    
                    if (oscillator && gainNode && !sustain) {
                        // å¦‚æœä¸æ˜¯å»¶éŸ³æ¨¡å¼ï¼Œå¿«é€Ÿé‡Šæ”¾éŸ³ç¬¦
                        const now = audioContext.currentTime;
                        gainNode.gain.cancelScheduledValues(now);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                        
                        setTimeout(() => {
                            oscillator.stop();
                        }, 100);
                    }
                    
                    // æ¸…é™¤å¼•ç”¨
                    delete keyElement.dataset.oscillator;
                }
            }
            
            // æ ¹æ®éŸ³ç¬¦å’Œå…«åº¦è·å–é¢‘ç‡
            function getFrequency(noteIndex, octave) {
                // æ ‡å‡†éŸ³A4 = 440Hz
                const A4_FREQUENCY = 440;
                const A4_OCTAVE = 4;
                const A4_INDEX = 9; // Aåœ¨noteNamesæ•°ç»„ä¸­çš„ç´¢å¼•
                
                // è®¡ç®—åŠéŸ³è·ç¦»
                const semitonesFromA4 = (octave - A4_OCTAVE) * 12 + (noteIndex - A4_INDEX);
                
                // è®¡ç®—é¢‘ç‡
                return A4_FREQUENCY * Math.pow(2, semitonesFromA4 / 12);
            }
            
            // é”®ç›˜äº‹ä»¶å¤„ç†
            function handleKeyDown(event) {
                const key = event.key.toLowerCase();
                
                // ç‰¹æ®ŠåŠŸèƒ½é”®
                if (key === ' ') {
                    event.preventDefault();
                    toggleSustain();
                    return;
                } else if (key === 'r') {
                    event.preventDefault();
                    toggleRecording();
                    return;
                } else if (key === 'p') {
                    event.preventDefault();
                    playRecording();
                    return;
                } else if (key === ']') {
                    event.preventDefault();
                    changeOctave(1);
                    return;
                } else if (key === '[') {
                    event.preventDefault();
                    changeOctave(-1);
                    return;
                }
                
                if (keyboardMap.hasOwnProperty(key)) {
                    event.preventDefault();
                    
                    const mapping = keyboardMap[key];
                    const noteIndex = mapping.noteIndex;
                    const octaveOffset = mapping.octaveOffset;
                    const noteName = noteNames[noteIndex];
                    const actualOctave = currentOctave + octaveOffset;
                    
                    // ç¡®ä¿å…«åº¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
                    if (actualOctave < 0 || actualOctave > 8) return;
                    
                    // æŸ¥æ‰¾å¯¹åº”çš„é”®å…ƒç´ 
                    const keyElement = document.querySelector(`.key[data-note="${noteName}${actualOctave}"]`);
                    
                    if (keyElement && !keyElement.classList.contains('active')) {
                        playNote(noteName, actualOctave, keyElement);
                    }
                }
            }
            
            function handleKeyUp(event) {
                const key = event.key.toLowerCase();
                
                if (keyboardMap.hasOwnProperty(key)) {
                    event.preventDefault();
                    
                    const mapping = keyboardMap[key];
                    const noteIndex = mapping.noteIndex;
                    const octaveOffset = mapping.octaveOffset;
                    const noteName = noteNames[noteIndex];
                    const actualOctave = currentOctave + octaveOffset;
                    
                    // ç¡®ä¿å…«åº¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
                    if (actualOctave < 0 || actualOctave > 8) return;
                    
                    const keyElement = document.querySelector(`.key[data-note="${noteName}${actualOctave}"]`);
                    
                    if (keyElement) {
                        stopNote(keyElement);
                    }
                }
            }
            
            // æ”¹å˜å…«åº¦
            function changeOctave(delta) {
                currentOctave = Math.max(0, Math.min(8, currentOctave + delta));
                updateOctaveDisplay();
                updateKeyLabels();
            }
            
            // æ›´æ–°å…«åº¦æ˜¾ç¤º
            function updateOctaveDisplay() {
                let octaveName = "ä¸­å¤®C";
                if (currentOctave < 4) octaveName = "ä½éŸ³åŒº";
                if (currentOctave > 4) octaveName = "é«˜éŸ³åŒº";
                
                octaveDisplay.textContent = `å½“å‰å…«åº¦: ${currentOctave} (${octaveName})`;
                octaveUpBtn.textContent = `æé«˜å…«åº¦ (${currentOctave})`;
                octaveDownBtn.textContent = `é™ä½å…«åº¦ (${currentOctave})`;
            }
            
            // æ›´æ–°é”®ç›˜æ ‡ç­¾
            function updateKeyLabels() {
                const keys = document.querySelectorAll('.key');
                keys.forEach(key => {
                    const noteFull = key.dataset.note;
                    const noteName = noteFull.slice(0, -1);
                    const octave = parseInt(noteFull.slice(-1));
                    
                    const keyLabel = findKeyLabel(noteName, octave);
                    const keyLabelElement = key.querySelector('.key-label');
                    
                    if (keyLabelElement) {
                        keyLabelElement.textContent = keyLabel || '';
                    }
                });
            }
            
            // åˆ‡æ¢å»¶éŸ³
            function toggleSustain() {
                sustain = !sustain;
                sustainBtn.textContent = `å»¶éŸ³: ${sustain ? 'å¼€' : 'å…³'}`;
                
                if (sustain) {
                    sustainBtn.classList.add('active-control');
                } else {
                    sustainBtn.classList.remove('active-control');
                    
                    // å…³é—­å»¶éŸ³æ—¶åœæ­¢æ‰€æœ‰æ­£åœ¨å»¶éŸ³çš„éŸ³ç¬¦
                    const activeKeys = document.querySelectorAll('.key.active');
                    activeKeys.forEach(key => {
                        const oscillatorData = key.dataset.oscillator;
                        if (oscillatorData) {
                            const { oscillator, gainNode } = JSON.parse(oscillatorData);
                            if (oscillator && gainNode) {
                                const now = audioContext.currentTime;
                                gainNode.gain.cancelScheduledValues(now);
                                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                                
                                setTimeout(() => {
                                    oscillator.stop();
                                    key.classList.remove('active');
                                }, 200);
                            }
                        }
                    });
                }
            }
            
            // åˆ‡æ¢å½•éŸ³
            function toggleRecording() {
                isRecording = !isRecording;
                
                if (isRecording) {
                    recordedNotes = [];
                    startTime = Date.now();
                    recordBtn.textContent = 'åœæ­¢å½•éŸ³';
                    playBtn.disabled = true;
                    recordBtn.classList.add('active-control');
                } else {
                    recordBtn.textContent = 'å¼€å§‹å½•éŸ³';
                    playBtn.disabled = false;
                    recordBtn.classList.remove('active-control');
                }
            }
            
            // æ’­æ”¾å½•éŸ³
            function playRecording() {
                if (recordedNotes.length === 0) return;
                
                recordedNotes.forEach(note => {
                    setTimeout(() => {
                        const keyElement = document.querySelector(`.key[data-note="${note.note}${note.octave}"]`);
                        if (keyElement) {
                            playNote(note.note, note.octave, keyElement);
                            
                            setTimeout(() => {
                                stopNote(keyElement);
                            }, note.duration);
                        }
                    }, note.time);
                });
            }
            
            // æŒ‰é’®äº‹ä»¶å¤„ç†
            sustainBtn.addEventListener('click', toggleSustain);
            
            recordBtn.addEventListener('click', toggleRecording);
            
            playBtn.addEventListener('click', playRecording);
            
            clearBtn.addEventListener('click', function() {
                recordedNotes = [];
                playBtn.disabled = true;
            });
            
            octaveUpBtn.addEventListener('click', function() {
                changeOctave(1);
            });
            
            octaveDownBtn.addEventListener('click', function() {
                changeOctave(-1);
            });
            
            // åˆå§‹åŒ–
            createPianoKeys();
            updateOctaveDisplay();
            getVisitorInfo(); // è·å–è®¿é—®è€…ä¿¡æ¯
            
            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
        });
            // æ˜¾ç¤ºå¯¹è¯æ¡†
            function showDialog() {
            document.getElementById('dialogOverlay').classList.add('active');
            }

            // éšè—å¯¹è¯æ¡†
            function hideDialog() {
            document.getElementById('dialogOverlay').classList.remove('active');
            }

            // ç‚¹å‡»é®ç½©å±‚å…³é—­å¯¹è¯æ¡†
            document.getElementById('dialogOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
            hideDialog();
            }
            });

            // æŒ‰ESCé”®å…³é—­å¯¹è¯æ¡†
            document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
            hideDialog();
            }
            });

    </script>
</body>
</html>